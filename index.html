import React, { useMemo, useState } from "react";
import { ShoppingCart, Star, Trash2, Search, Moon, Sun, ChevronDown, Grid2X2, ListFilter, Heart, CheckCircle2 } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";

// ---------- Utilities
const currency = (n) => `₹${n.toLocaleString("en-IN", { maximumFractionDigits: 0 })}`;

const Rating = ({ value = 0 }) => (
  <div className="flex items-center gap-1" aria-label={`Rating ${value} out of 5`}>
    {Array.from({ length: 5 }).map((_, i) => (
      <Star key={i} className={`h-4 w-4 ${i < Math.round(value) ? "fill-current" : "fill-transparent"}`} />
    ))}
  </div>
);

const AddToCartButton = ({ onClick }) => (
  <button
    onClick={onClick}
    className="inline-flex items-center gap-2 rounded-2xl px-4 py-2 shadow-sm border hover:shadow-md transition active:scale-[.98]"
  >
    <ShoppingCart className="h-4 w-4" />
    Add to cart
  </button>
);

// ---------- Demo data (remote image URLs; no local files)
const catalogs = {
  fashion: {
    title: "Luxe Boutique",
    tagline: "New-season styles, timeless silhouettes.",
    hero: "https://images.unsplash.com/photo-1520975594087-6a6f2a3f7a3b?q=80&w=1400&auto=format&fit=crop",
    bannerClass: "from-rose-100 via-pink-50 to-white",
    products: [
      {
        id: "lx-dress",
        name: "Satin Slip Dress",
        price: 2999,
        rating: 4.5,
        img: "https://images.unsplash.com/photo-1520975723139-5be1b8f9b6a6?q=80&w=1200&auto=format&fit=crop",
        tag: "Bestseller",
      },
      {
        id: "lx-tee",
        name: "Oversized Graphic Tee",
        price: 999,
        rating: 4.2,
        img: "https://images.unsplash.com/photo-1512436991641-6745cdb1723f?q=80&w=1200&auto=format&fit=crop",
        tag: "New",
      },
      {
        id: "lx-sneaker",
        name: "Retro Court Sneakers",
        price: 4499,
        rating: 4.7,
        img: "https://images.unsplash.com/photo-1542291026-7eec264c27ff?q=80&w=1200&auto=format&fit=crop",
        tag: "Trending",
      },
      {
        id: "lx-bag",
        name: "Mini Crossbody Bag",
        price: 1899,
        rating: 4.1,
        img: "https://images.unsplash.com/photo-1548036328-c9fa89d128fa?q=80&w=1200&auto=format&fit=crop",
        tag: "Limited",
      },
    ],
    filters: ["Women", "Men", "Accessories", "New In"],
  },
  electronics: {
    title: "VoltTech",
    tagline: "Cutting-edge gadgets at honest prices.",
    hero: "https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=1400&auto=format&fit=crop",
    bannerClass: "from-indigo-100 via-slate-50 to-white",
    products: [
      {
        id: "vt-headphones",
        name: "Noise-Canceling Headphones",
        price: 6999,
        rating: 4.6,
        img: "https://images.unsplash.com/photo-1518441902113-c1d4e3a76f56?q=80&w=1200&auto=format&fit=crop",
        tag: "Hot",
      },
      {
        id: "vt-smartwatch",
        name: "AMOLED Smartwatch",
        price: 5499,
        rating: 4.3,
        img: "https://images.unsplash.com/photo-1511385348-a52b4a160dc2?q=80&w=1200&auto=format&fit=crop",
        tag: "New",
      },
      {
        id: "vt-laptop",
        name: "UltraThin Laptop 14",
        price: 57999,
        rating: 4.5,
        img: "https://images.unsplash.com/photo-1517336714731-489689fd1ca8?q=80&w=1200&auto=format&fit=crop",
        tag: "Deal",
      },
      {
        id: "vt-buds",
        name: "TWS Earbuds Pro",
        price: 3499,
        rating: 4.0,
        img: "https://images.unsplash.com/photo-1585386959984-a4155223168f?q=80&w=1200&auto=format&fit=crop",
        tag: "Value",
      },
    ],
    filters: ["Phones", "Audio", "Laptops", "Wearables"],
  },
  grocery: {
    title: "DailyFresh",
    tagline: "Farm to doorstep in under 24h.",
    hero: "https://images.unsplash.com/photo-1542831371-29b0f74f9713?q=80&w=1400&auto=format&fit=crop",
    bannerClass: "from-emerald-100 via-green-50 to-white",
    products: [
      {
        id: "df-apples",
        name: "Organic Honeycrisp Apples (1kg)",
        price: 199,
        rating: 4.8,
        img: "https://images.unsplash.com/photo-1579613832125-5d34a13ffe36?q=80&w=1200&auto=format&fit=crop",
        tag: "Fresh",
      },
      {
        id: "df-bread",
        name: "Sourdough Bread",
        price: 149,
        rating: 4.4,
        img: "https://images.unsplash.com/photo-1549931319-a545dcf3bc73?q=80&w=1200&auto=format&fit=crop",
        tag: "Bakery",
      },
      {
        id: "df-milk",
        name: "A2 Desi Cow Milk (1L)",
        price: 89,
        rating: 4.6,
        img: "https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&w=1200&auto=format&fit=crop",
        tag: "Dairy",
      },
      {
        id: "df-spinach",
        name: "Baby Spinach (250g)",
        price: 79,
        rating: 4.2,
        img: "https://images.unsplash.com/photo-1506806732259-39c2d0268443?q=80&w=1200&auto=format&fit=crop",
        tag: "Leafy",
      },
    ],
    filters: ["Fruits", "Vegetables", "Dairy", "Bakery"],
  },
  furniture: {
    title: "NordLoft",
    tagline: "Minimal furniture. Maximum comfort.",
    hero: "https://images.unsplash.com/photo-1493666438817-866a91353ca9?q=80&w=1400&auto=format&fit=crop",
    bannerClass: "from-amber-100 via-orange-50 to-white",
    products: [
      {
        id: "nl-sofa",
        name: "Cloud Sectional Sofa",
        price: 89999,
        rating: 4.7,
        img: "https://images.unsplash.com/photo-1493666438817-866a91353ca9?q=80&w=1200&auto=format&fit=crop",
        tag: "Premium",
      },
      {
        id: "nl-chair",
        name: "Ergo Lounge Chair",
        price: 12999,
        rating: 4.4,
        img: "https://images.unsplash.com/photo-1501045661006-fcebe0257c3f?q=80&w=1200&auto=format&fit=crop",
        tag: "Ergonomic",
      },
      {
        id: "nl-desk",
        name: "Solid Wood Work Desk",
        price: 21999,
        rating: 4.5,
        img: "https://images.unsplash.com/photo-1519710164239-da123dc03ef4?q=80&w=1200&auto=format&fit=crop",
        tag: "Workspace",
      },
      {
        id: "nl-lamp",
        name: "Arc Floor Lamp",
        price: 4999,
        rating: 4.1,
        img: "https://images.unsplash.com/photo-1503602642458-232111445657?q=80&w=1200&auto=format&fit=crop",
        tag: "Lighting",
      },
    ],
    filters: ["Living", "Workspace", "Lighting", "Storage"],
  },
};

const themes = {
  fashion: "[--brand:theme(colors.rose.600)]",
  electronics: "[--brand:theme(colors.indigo.600)]",
  grocery: "[--brand:theme(colors.emerald.600)]",
  furniture: "[--brand:theme(colors.amber.600)]",
};

// ---------- Product Card
const ProductCard = ({ p, onAdd, layout = "grid" }) => (
  <motion.div
    layout
    whileHover={{ y: -2 }}
    className="group rounded-2xl border bg-white/70 dark:bg-zinc-900/70 backdrop-blur p-3 shadow-sm hover:shadow-md transition"
  >
    <div className="relative overflow-hidden rounded-xl aspect-[4/3]">
      <img src={p.img} alt={p.name} className="h-full w-full object-cover" loading="lazy" />
      <div className="absolute left-2 top-2 rounded-full bg-white/90 dark:bg-black/60 px-2 py-1 text-xs shadow">
        {p.tag}
      </div>
      <button className="absolute right-2 top-2 rounded-full bg-white/90 dark:bg-black/60 p-2 shadow opacity-0 group-hover:opacity-100 transition">
        <Heart className="h-4 w-4" />
      </button>
    </div>
    <div className="mt-3 flex items-start justify-between gap-2">
      <div>
        <div className="font-medium leading-tight">{p.name}</div>
        <div className="text-sm text-zinc-500 dark:text-zinc-400">{currency(p.price)}</div>
        <div className="mt-1"><Rating value={p.rating} /></div>
      </div>
      <AddToCartButton onClick={() => onAdd(p)} />
    </div>
  </motion.div>
);

// ---------- Cart Drawer
const CartDrawer = ({ open, setOpen, items, remove, inc, dec }) => {
  const total = items.reduce((s, it) => s + it.price * it.qty, 0);
  return (
    <AnimatePresence>
      {open && (
        <motion.aside
          key="cart"
          initial={{ x: 400, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          exit={{ x: 400, opacity: 0 }}
          transition={{ type: "spring", stiffness: 240, damping: 24 }}
          className="fixed right-0 top-0 h-full w-full max-w-md bg-white dark:bg-zinc-950 border-l shadow-2xl z-50 flex flex-col"
        >
          <div className="p-4 flex items-center justify-between border-b">
            <div className="font-semibold text-lg flex items-center gap-2"><ShoppingCart className="h-5 w-5" />Your Cart</div>
            <button className="rounded-xl border px-3 py-1" onClick={() => setOpen(false)}>Close</button>
          </div>
          <div className="flex-1 overflow-y-auto p-4 flex flex-col gap-3">
            {items.length === 0 && (
              <div className="text-center text-zinc-500 py-12">Your cart is empty.</div>
            )}
            {items.map((it) => (
              <div key={it.id} className="flex gap-3 items-center border rounded-xl p-3">
                <img src={it.img} alt={it.name} className="h-16 w-16 rounded-lg object-cover" />
                <div className="flex-1">
                  <div className="font-medium leading-tight">{it.name}</div>
                  <div className="text-sm text-zinc-500">{currency(it.price)} • Qty {it.qty}</div>
                  <div className="mt-2 flex items-center gap-2">
                    <button onClick={() => dec(it.id)} className="rounded-lg border px-2 py-1">-</button>
                    <button onClick={() => inc(it.id)} className="rounded-lg border px-2 py-1">+</button>
                  </div>
                </div>
                <button onClick={() => remove(it.id)} className="rounded-lg p-2 hover:bg-zinc-100 dark:hover:bg-zinc-900">
                  <Trash2 className="h-5 w-5" />
                </button>
              </div>
            ))}
          </div>
          <div className="p-4 border-t space-y-3">
            <div className="flex items-center justify-between font-medium">
              <span>Subtotal</span>
              <span>{currency(total)}</span>
            </div>
            <button className="w-full rounded-2xl bg-[var(--brand)] text-white py-3 font-medium hover:opacity-90 transition">
              Checkout
            </button>
            <div className="text-xs text-zinc-500 text-center">Secure checkout • Free returns within 7 days</div>
          </div>
        </motion.aside>
      )}
    </AnimatePresence>
  );
};

// ---------- Header
const Header = ({ dark, setDark, cartCount, onCart }) => (
  <header className="sticky top-0 z-40 backdrop-blur border-b bg-white/70 dark:bg-zinc-950/60">
    <div className="mx-auto max-w-7xl px-4 py-3 flex items-center gap-3">
      <div className="text-xl font-bold tracking-tight">MultiShop</div>
      <div className="ml-auto flex items-center gap-2">
        <button
          onClick={() => setDark(!dark)}
          className="rounded-xl border px-3 py-2 inline-flex items-center gap-2"
        >
          {dark ? <Sun className="h-4 w-4" /> : <Moon className="h-4 w-4" />}
          <span className="hidden sm:inline">{dark ? "Light" : "Dark"} mode</span>
        </button>
        <button onClick={onCart} className="relative rounded-xl border px-3 py-2 inline-flex items-center gap-2">
          <ShoppingCart className="h-4 w-4" />
          <span className="hidden sm:inline">Cart</span>
          {cartCount > 0 && (
            <span className="absolute -top-2 -right-2 h-5 min-w-[20px] rounded-full bg-[var(--brand)] text-white text-xs grid place-items-center px-1">
              {cartCount}
            </span>
          )}
        </button>
      </div>
    </div>
  </header>
);

// ---------- Toolbar
const Toolbar = ({ q, setQ, sort, setSort, activeFilters = [], toggleFilter }) => (
  <div className="mx-auto max-w-7xl px-4 py-4 grid gap-3 md:grid-cols-3">
    <div className="flex items-center gap-2 rounded-2xl border px-3 py-2">
      <Search className="h-4 w-4" />
      <input
        value={q}
        onChange={(e) => setQ(e.target.value)}
        placeholder="Search products"
        className="w-full bg-transparent outline-none"
      />
    </div>

    <div className="flex items-center gap-2">
      <div className="rounded-2xl border px-3 py-2 inline-flex items-center gap-2">
        <Grid2X2 className="h-4 w-4" />
        <span>View</span>
        <ChevronDown className="h-4 w-4" />
      </div>
      <div className="rounded-2xl border px-3 py-2 inline-flex items-center gap-2">
        <ListFilter className="h-4 w-4" />
        <span>Filters</span>
      </div>
    </div>

    <div className="md:ml-auto flex items-center justify-end">
      <select
        value={sort}
        onChange={(e) => setSort(e.target.value)}
        className="rounded-2xl border px-3 py-2 w-full md:w-auto"
      >
        <option value="featured">Sort: Featured</option>
        <option value="price-asc">Price: Low to High</option>
        <option value="price-desc">Price: High to Low</option>
        <option value="rating-desc">Rating: High to Low</option>
      </select>
    </div>

    {activeFilters?.length > 0 && (
      <div className="md:col-span-3 flex flex-wrap items-center gap-2">
        {activeFilters.map((f) => (
          <span key={f} className="inline-flex items-center gap-1 rounded-full border px-3 py-1 text-sm">
            <CheckCircle2 className="h-4 w-4" /> {f}
          </span>
        ))}
      </div>
    )}
  </div>
);

// ---------- Category Nav
const CategoryPills = ({ items = [], onPick }) => (
  <div className="mx-auto max-w-7xl px-4 pb-2 flex flex-wrap gap-2">
    {items.map((i) => (
      <button
        key={i}
        onClick={() => onPick?.(i)}
        className="rounded-full border px-3 py-1 text-sm hover:bg-black/5 dark:hover:bg-white/5"
      >
        {i}
      </button>
    ))}
  </div>
);

// ---------- Template Section
const Template = ({ name, data, onAdd }) => {
  const [q, setQ] = useState("");
  const [sort, setSort] = useState("featured");

  const filtered = useMemo(() => {
    const base = data.products.filter((p) => p.name.toLowerCase().includes(q.toLowerCase()));
    switch (sort) {
      case "price-asc":
        return [...base].sort((a, b) => a.price - b.price);
      case "price-desc":
        return [...base].sort((a, b) => b.price - a.price);
      case "rating-desc":
        return [...base].sort((a, b) => b.rating - a.rating);
      default:
        return base;
    }
  }, [q, sort, data.products]);

  return (
    <section className={`${themes[name]} pb-16`}>
      {/* Hero */}
      <div className={`bg-gradient-to-br ${data.bannerClass}`}>
        <div className="mx-auto max-w-7xl grid md:grid-cols-2 gap-6 items-center px-4 py-10">
          <div className="space-y-3">
            <div className="text-sm uppercase tracking-widest text-[var(--brand)]">{name.toUpperCase()}</div>
            <h1 className="text-3xl md:text-4xl font-extrabold tracking-tight">{data.title}</h1>
            <p className="text-zinc-600 dark:text-zinc-400 max-w-prose">{data.tagline}</p>
            <div className="flex gap-2 pt-2">
              <button className="rounded-2xl bg-[var(--brand)] text-white px-5 py-2 font-medium">Shop now</button>
              <button className="rounded-2xl border px-5 py-2">Explore</button>
            </div>
          </div>
          <div className="rounded-3xl overflow-hidden shadow-xl border">
            <img src={data.hero} alt={`${data.title} hero`} className="w-full h-full object-cover" />
          </div>
        </div>
      </div>

      {/* Search & Filters */}
      <Toolbar q={q} setQ={setQ} sort={sort} setSort={setSort} />
      <CategoryPills items={data.filters} />

      {/* Grid */}
      <div className="mx-auto max-w-7xl px-4 grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
        <AnimatePresence>
          {filtered.map((p) => (
            <ProductCard key={p.id} p={p} onAdd={onAdd} />
          ))}
        </AnimatePresence>
      </div>
    </section>
  );
};

// ---------- Main App (multiple websites in one showcase)
export default function MultiEcommerceShowcase() {
  const [dark, setDark] = useState(false);
  const [site, setSite] = useState("fashion");
  const [cartOpen, setCartOpen] = useState(false);
  const [items, setItems] = useState([]);

  const add = (p) =>
    setItems((prev) => {
      const found = prev.find((x) => x.id === p.id);
      if (found) return prev.map((x) => (x.id === p.id ? { ...x, qty: x.qty + 1 } : x));
      return [...prev, { ...p, qty: 1 }];
    });
  const remove = (id) => setItems((prev) => prev.filter((x) => x.id !== id));
  const inc = (id) => setItems((prev) => prev.map((x) => (x.id === id ? { ...x, qty: x.qty + 1 } : x)));
  const dec = (id) =>
    setItems((prev) => prev.map((x) => (x.id === id && x.qty > 1 ? { ...x, qty: x.qty - 1 } : x)));

  const tabs = [
    { key: "fashion", label: "Fashion" },
    { key: "electronics", label: "Electronics" },
    { key: "grocery", label: "Grocery" },
    { key: "furniture", label: "Furniture" },
  ];

  return (
    <div className={dark ? "dark" : ""}>
      <div className="min-h-screen bg-zinc-50 dark:bg-zinc-950 text-zinc-900 dark:text-zinc-100">
        <Header dark={dark} setDark={setDark} cartCount={items.length} onCart={() => setCartOpen(true)} />

        {/* Site Switcher */}
        <div className="mx-auto max-w-7xl px-4 py-4">
          <div className="flex flex-wrap gap-2">
            {tabs.map((t) => (
              <button
                key={t.key}
                onClick={() => setSite(t.key)}
                className={`rounded-2xl border px-4 py-2 ${
                  site === t.key ? "bg-[var(--brand)] text-white" : "hover:bg-black/5 dark:hover:bg-white/5"
                } ${themes[t.key]}`}
              >
                {t.label}
              </button>
            ))}
          </div>
        </div>

        {/* Templates */}
        <main>
          <AnimatePresence mode="wait">
            <motion.div
              key={site}
              initial={{ opacity: 0, y: 8 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -8 }}
              transition={{ duration: 0.25 }}
            >
              <Template name={site} data={catalogs[site]} onAdd={add} />
            </motion.div>
          </AnimatePresence>
        </main>

        <CartDrawer
          open={cartOpen}
          setOpen={setCartOpen}
          items={items}
          remove={remove}
          inc={inc}
          dec={dec}
        />

        {/* Footer */}
        <footer className="border-t mt-10">
          <div className="mx-auto max-w-7xl px-4 py-6 text-sm text-zinc-500 flex flex-wrap gap-3 items-center justify-between">
            <div>© {new Date().getFullYear()} MultiShop Showcase</div>
            <div className="flex gap-4">
              <a href="#" className="hover:underline">Privacy</a>
              <a href="#" className="hover:underline">Terms</a>
              <a href="#" className="hover:underline">Help</a>
            </div>
          </div>
        </footer>
      </div>
    </div>
  );
}
